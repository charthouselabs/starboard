* Events
** VaultAbi Events
*** Positions
**** Increase Position
:PROPERTIES:
:pub key: b256
:pub account: Identity
:pub collateral_asset: AssetId
:pub index_asset: AssetId
:pub collateral_delta: u256
:pub size_delta: u256
:pub is_long: bool
:pub price: u256
:pub fee: u256
:END:

- TODO Updates Position (new | increase)
  - Position status = open
  - side = is_long ? LONG : SHORT
  - size = size_delta
  - maxSize = ?constant?
  - entryPrice = price | (calculate average entry price)
  - exitPrice = null
  - realized_pnl = 0 | (realized_pnl)
  - createdAt = block.timestamp
  - createdAtHeight = block.height
  - sumOpen ?
  - sumClose ?
  - netFunding = 0 ??
  - unrealizedPnl = 0 | (calculate)
  - closeAt = null
  - subaccountNumber = 0
  - ticker = index_asset.ticker
  - collateral = 0 | +=collateral_delta
  - positionFees = ??? ;; is this needed
  - lastIncreasedTime = block.timestamp
  - account = Accounts.get_or_create(account)
  - market = Market.get_by_index_asset(index_asset)

- TODO Creates Trade
  - createdatHeight = block.height
  - createdAt = block.timestamp
  - side = Buy
  - size = size_delta
  - tradeType = limit
  - market = Market.get_by_index_asset(index_asset)
  - position = new_position

- TODO Updates total open interest
  - Market.openInterest += is_long ? size : -size

**** Close Position
:PROPERTIES:
:pub key: b256
:pub size: u256
:pub collateral: u256
:pub average_price: u256
:pub entry_funding_rate: u256
:pub reserve_amount: u256
:pub realized_pnl: Signed256
:END:

- TODO Updates Position
  - Position status = closed
  - exitPrice = price
  - realized_pnl += realized_pnl
  - sumOpen ?
  - sumClose ?
  - netFunding = 0 ??
  - unrealizedPnl = 0
  - closeAt = block.timestamp

- TODO Creates Trade
  - createdatHeight = block.height
  - createdAt = block.timestamp
  - side = Sell
  - size = size_delta
  - tradeType = limit
  - market = Market.get_by_index_asset(index_asset)
  - position = new_position

- TODO Updates total open interest
  - Market.openInterest += is_long ? -size : size

**** Decrease Position
:PROPERTIES:
:pub key: b256
:pub account: Identity
:pub collateral_asset: AssetId
:pub index_asset: AssetId
:pub collateral_delta: u256
:pub size_delta: u256
:pub is_long: bool
:pub price: u256
:pub fee: u256
:END:

- TODO Updates Position
  - size -= size_delta
  - maxSize = ?constant?
  - realized_pnl = ??? ;; calculate?
  - sumOpen ?
  - sumClose ?
  - netFunding = 0 ??
  - unrealizedPnl = ??? ;; calculate decrease
  - collateral -= collateral_delta
  - positionFees = ??? ;; needed?

- TODO Creates Trade
  - createdatHeight = block.height
  - createdAt = block.timestamp
  - side = Sell
  - size = size_delta
  - tradeType = limit
  - market = Market.get_by_index_asset(index_asset)
  - position = new_position

- TODO Updates total open interest
  - Market.openInterest += is_long ? size : -size

**** RegisterPositionByKey ?
- TODO Verify if this indicates a completely new position
- TODO Confirm if only happens on very first position creation
- TODO Decide if this event is useful

**** Liquidate Position
:PROPERTIES:
:pub key: b256
:pub account: Identity
:pub collateral_asset: AssetId
:pub index_asset: AssetId
:pub is_long: bool
:pub size: u256
:pub collateral: u256
:pub reserve_amount: u256
:pub realized_pnl: Signed256
:pub mark_price: u256
:END:

- TODO Updates Position
- TODO Creates Trade
- TODO Updates trader PNL
- TODO Updates total open interest

*** Market
**** Set Asset Config
:PROPERTIES:
:pub asset: AssetId
:pub asset_decimals: u32
:pub asset_weight: u64
:pub min_profit_bps: u64
:pub max_rusd_amount: u256
:pub is_stable: bool
:pub is_shortable: bool
:END:

- TODO Add market
- TODO Update whitelisted assets
- TODO Update Market

*** Funding Rates
**** Set Funding Rate Info
:PROPERTIES:
:pub asset: AssetId
:pub funding_rate: u256
:END:

- TODO Update Funding Rate

** Price Feed
*** Set Price
:PROPERTIES:
:pub asset: AssetId
:pub price: Price
:pub timestamp: u64
:END:

- TODO Create new price tick
- TODO Update all price intervals
